{% extends 'admin/base.html.twig' %}

{% block title %}Liste des utilisateurs{% endblock %}

{% block body %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-8">Liste des utilisateurs</h1>

        {# Flash messages #}
        {% for type, messages in app.flashes %}
            {% set color = {
                'success': 'green',
                'error': 'red',
                'danger': 'red',
                'warning': 'yellow',
                'info': 'blue'
            }[type]|default('gray') %}
            <div class="fixed inset-x-0 top-16 flex flex-col items-center space-y-2 z-50">
                {% for message in messages %}
                    <div class="flash-message w-1/2 bg-{{ color }}-100 text-{{ color }}-800 border border-{{ color }}-300 rounded-md shadow-md px-4 py-3 opacity-100 transition-all duration-500">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}

        <div data-controller="datatables" class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
            <table id="table" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Prénom</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Nom</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Rôle(s)</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Téléphone</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Créé le</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Adresse de facturation</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Etudiants associés</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                {% for user in users %}
                    <tr class="hover:bg-gray-100 transition-colors duration-200">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ user.firstName }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ user.lastName }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">{{ user.email }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ user.roles|join(', ') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ user.phoneNumber }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ user.createdAt ? user.createdAt|date('d/m/Y H:i') : '' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ user.FullBillingAddress }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            {% if user.students|length > 0 %}
                                <ul>
                                    {% for student in user.students %}
                                        <li>{{ student.fullName }}</li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                Aucun étudiant associé
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            <form method="post" action="{{ path('admin_user_delete', {id: user.id}) }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ user.id) }}">
                                <button type="submit"
                                        class="bg-red-600 hover:bg-red-700 text-white font-semibold px-3 py-1 rounded-md transition-colors duration-200">
                                    Supprimer
                                </button>
                            </form>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="9" class="px-6 py-12 text-center text-gray-500 text-sm">Aucun utilisateur trouvé.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Fade-out automatique des flash messages
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.flash-message').forEach((el) => {
                setTimeout(() => {
                    el.classList.add('opacity-0', '-translate-y-4');
                    setTimeout(() => el.remove(), 500);
                }, 3000);
            });
        });
    </script>
{% endblock %}
